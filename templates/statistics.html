<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
        <link href="/static/jsmaps/jsmaps.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script crossorigin="anonymous"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
    li,h3{
    color:white
    }
      #world-map {
            width: 50%; /* Imposta la larghezza al 50% del contenitore */
            float: left; /* Posiziona il div a sinistra */
        }

        #testo {
            width: 50%; /* Imposta la larghezza al 50% del contenitore */
            float: right; /* Posiziona il div a destra */
        }

    #testo{
    background:#c6612c;
    border-radius: 10px;
    padding: 3px;
    }
    #testo{
        float: center; /* Posiziona il div a destra */
        width: 50%; /* Imposta la larghezza al 50% del contenitore */
    }
</style>
    <title>Statistics</title>
</head>

<body>
    <div class="navbar">
        <a href="/">Home</a>
        <a href="/add-document">Add document</a>
        <a href="/search">Search</a>
        <a href="/statistics" class="active">Statistics</a>
    </div>
    <h2>Seleziona un elemento dalla lista:</h2>
    <form action="/statistics/average-revenue" method="get" id="media-form">
        <label for="genere">Scegli genere:</label>
        <select id="genere" name="genre">
            {% for genre_item in genre_list %}
            {% if genre_item==genre %}
            <option selected="selected" value="{{ genre_item }}">{{ genre_item }}</option>
            {% else %}
            <option value="{{ genre_item }}">{{ genre_item }}</option>
            {% endif %}
            {% endfor %}
        </select>
        <br><br>
        <input type="submit" value="Mostra media">
    </form>
    <p id="media"></p>

    <canvas id="histogram"></canvas>

    <div style="width:600px; display:inline">
<div class="jsmaps-wrapper" id="world-map"></div>
</div>
    <script>
document.getElementById('media-form').addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent form submission

  // Get form data
  const formData = new FormData(this);
  // Send AJAX request
  fetch('/statistics/media?genre='+encodeURI(formData.get("genre")), {
    method: 'GET'
  })
  .then(function(response) {
    if (response.ok) {
      // Request successful, process the response
      // You can display a success message or perform any other actions
        return response.json();
    } else {
      // Request failed, handle the error
      console.error('Form submission failed');
    }
  })

  .then(function(data) {
    // Process the JSON response
    document.getElementById("media").innerText="Media "+formData.get("genre")+": "+data;
    // You can access the data fields and perform any necessary actions
  })
  .catch(function(error) {
    // Network error or request failed
    console.error('Error:', error);
  });
});
    </script>
<script src="/static/jsmaps/jsmaps-libs.js" type="text/javascript"></script>
<script src="/static/jsmaps/jsmaps-panzoom.js" type="text/javascript"></script>
<script src="/static/jsmaps/jsmaps.min.js" type="text/javascript"></script>
<script src="/static/jsmaps/world.js" type="text/javascript"></script>
<script type="text/javascript">

    function toGood(country_name, obj) {
        if (!obj) return "";
        // Initialize the HTML string
        let htmlString = '<div id="testo">';

        // Add the movie count
        htmlString += '<h2>Movie Count in ' + country_name + ': ' + obj["movie_count"] + '</h2>';
        htmlString += '<h3>Popular genres:</h3>'
        // Add the top genres
        htmlString += '<ul>';
        obj["top_genres"].forEach(function (genre) {
            htmlString += '<li>' + genre.genre + ' (' + genre.count + ')</li>';
        });
        htmlString += '</ul>';

        // Close the wrapping div
        htmlString += '</div>';

        return htmlString;

    }

    const mapJson = JSON.parse('{{ map_data|tojson }}');
    window.JSMaps.maps.world.config.defaultText = "";
    for (let i = 0; i < window.JSMaps.maps.world.paths.length; i++) {
        const item = window.JSMaps.maps.world.paths[i];
        const abbr = item["abbreviation"];
        const targetIndex = mapJson.findIndex(function (obj) {
            return obj["country"] === abbr;
        });
        if (targetIndex === -1) {
            item["enable"] = false;
            continue;
        }

        item["text"] = toGood(item["name"], mapJson[targetIndex]);
    }


    $(function () {
        $('#world-map').JSMaps({
            map: 'world', //Use any map as named in the maps folder e.g. usa
            enablePanZoom:true
        });
    });


</script>



    <script>
        const genresRevenues = JSON.parse('{{ genres_revenue_10|tojson }}');
        const labels = genresRevenues.map(item => item._id);
        const data = genresRevenues.map(item => item.averageRevenue);

        //const averageRevenue = {{ average_revenue }};



        const ctx = document.getElementById('histogram').getContext('2d');
        const chartData = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Media Revenue',
                    data: data,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            /*line1: {
                                type: 'line',
                                yMin: averageRevenue, // The y-value at which the line starts
                                yMax: averageRevenue, // The y-value at which the line ends
                                borderColor: 'red',
                                borderWidth: 2
                            }*/
                        }
                    }
                }
            }
        };
        const params = new URLSearchParams(window.location.search);
        const testValue = params.get('genre');
        chartData.data.datasets[0].backgroundColor = generateBackgroundColorArray(labels.indexOf(testValue));
        const chart = new Chart(ctx, chartData);

        function generateBackgroundColorArray(targetIndex) {
            const backgroundColors = Array(chartData.data.labels.length).fill('rgba(0, 123, 255, 0.5)'); // Default color for all bars
            if (targetIndex !== -1) {
                backgroundColors[targetIndex] = 'rgba(255, 0, 0, 0.5)'; // Custom color for the specified index
            }
            return backgroundColors;
        }

    </script>
</body>

</html>